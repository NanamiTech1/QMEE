<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Ian Dworkin and Ben Bolker" />
  <meta name="date" content="2017-03-17" />
  <title>Multivariate modeling via mixed models</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="qmee.css" type="text/css" />
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<header class="site-header">
<div class="wrapper">
	<h1 class="title">
		<a href="index.html">Biology 708, McMaster University</a>
	</h1>
	<div style="text-align:center">
		<img src="http://imgs.xkcd.com/comics/self_description.png">
	</div>
</div>
</header>
<div id="header">
<h1 class="title">Multivariate modeling via mixed models</h1>
<h2 class="author">Ian Dworkin and Ben Bolker</h2>
<h3 class="date">March 17, 2017</h3>
</div>
<p>This lecture follows on from last Wednesday’s: rather than fitting several linear models (each for a different response variable) simultaneously, we’re going to use a <em>mixed model</em> to fit multivariate data.</p>
<p>Useful packages:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(MCMCglmm)
<span class="kw">library</span>(lme4)
<span class="kw">library</span>(brms)</code></pre></div>
<pre><code>## Error in library(brms): there is no package called &#39;brms&#39;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyr)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(corrplot)</code></pre></div>
<pre><code>## Error in library(corrplot): there is no package called &#39;corrplot&#39;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(broom)
## need BMB&#39;s version from github:
##  devtools::install_github(&quot;bbolker/broom&quot;)
<span class="kw">library</span>(dotwhisker)
<span class="kw">library</span>(ggplot2); <span class="kw">theme_set</span>(<span class="kw">theme_bw</span>())</code></pre></div>
<p>Get data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_url &lt;-<span class="st"> &quot;http://datadryad.org/bitstream/handle/10255/dryad.8377/dll.csv&quot;</span>
if (!<span class="kw">file.exists</span>(<span class="st">&quot;dll.csv&quot;</span>)) {
    <span class="kw">download.file</span>(data_url,<span class="dt">dest=</span><span class="st">&quot;dll.csv&quot;</span>)
}
dll_data &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;dll.csv&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## make temp a factor (25 vs 30 degrees)
dll_data$temp &lt;-<span class="st"> </span><span class="kw">factor</span>(dll_data$temp)
## scale relevant variables (fancier but less repetition than previously)
morph_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;femur&quot;</span>,<span class="st">&quot;tibia&quot;</span>,<span class="st">&quot;tarsus&quot;</span>,<span class="st">&quot;SCT&quot;</span>)
morph_vars_sc &lt;-<span class="st"> </span><span class="kw">paste</span>(morph_vars,<span class="st">&quot;s&quot;</span>,<span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)
dll_data2 &lt;-<span class="st"> </span>dll_data
## c() drops unwanted structure from the results of scale()
for (i in <span class="dv">1</span>:<span class="kw">length</span>(morph_vars)) {
    dll_data2[[morph_vars_sc[i]]] &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">scale</span>(dll_data[[morph_vars[i]]]))
}</code></pre></div>
<h2 id="mixed-models">Mixed models</h2>
<p>The previous expression for the multivariate model was</p>
<p><span class="math display">\[ 
\mathbf{Y} = \mathbf{XB} + \mathbf{E}
\]</span></p>
<p>In contrast, the expression for the mixed model is</p>
<p><span class="math display">\[ 
y = \mathbf{X\beta} + \mathbf{Zb} + \epsilon
\]</span></p>
<p>where <span class="math inline">\(\mathbf{b}\)</span> is a set of Gaussian variables with a variance-covariance matrix <span class="math inline">\(\mathbf{\Sigma}\)</span> which we estimate.</p>
<p>Suppose we have observations of <span class="math inline">\(m\)</span> individuals, with <span class="math inline">\(p\)</span> different observations (traits, or time points, or types of measurement, or …) for each individual. The way we’re going to make this work is to expand (“melt”, or <code>gather()</code> if we’re using <code>tidyr</code>) the data set to be <span class="math inline">\(mp\)</span> observations long, then treat each individual (which was previously a single row of the data set but now comprises <span class="math inline">\(p\)</span> rows) as a group (we’ll call this <code>units</code>):</p>
<h2 id="melting-code">melting code</h2>
<p><img src="figure/the-persistence-of-memory-1931.jpg" alt="melting" style="width: 100px;" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dll_melt &lt;-<span class="st"> </span>(dll_data2
    %&gt;%<span class="st"> </span><span class="kw">select</span>(-<span class="kw">c</span>(femur,tibia,tarsus,SCT))  ## drop unscaled vars
    %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">units=</span><span class="kw">factor</span>(<span class="dv">1</span>:<span class="kw">n</span>()))
    %&gt;%<span class="st"> </span><span class="kw">gather</span>(trait,value, -<span class="kw">c</span>(units,replicate,line,genotype,temp))
    %&gt;%<span class="st"> </span>na.omit
)</code></pre></div>
<h2 id="lmer-fit">lmer fit</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">t1 &lt;-<span class="st"> </span><span class="kw">system.time</span>(
    lmer1 &lt;-<span class="st"> </span><span class="kw">lmer</span>(value ~<span class="st"> </span>trait:(genotype*temp) -<span class="st"> </span><span class="dv">1</span> +
<span class="st">                      </span>(trait<span class="dv">-1</span>|line) +<span class="st"> </span>(trait<span class="dv">-1</span>|units),
                  <span class="dt">data=</span>dll_melt,
                  <span class="dt">control=</span><span class="kw">lmerControl</span>(<span class="dt">check.nobs.vs.nlev=</span><span class="st">&quot;ignore&quot;</span>,
                                      <span class="dt">check.nobs.vs.nRE=</span><span class="st">&quot;ignore&quot;</span>))
)</code></pre></div>
<pre><code>## Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control
## $checkConv, : unable to evaluate scaled gradient</code></pre>
<pre><code>## Warning in checkConv(attr(opt, &quot;derivs&quot;), opt$par, ctrl = control
## $checkConv, : Model failed to converge: degenerate Hessian with 1 negative
## eigenvalues</code></pre>
<h2 id="lme4-fixed-effects-formula">lme4: fixed-effects formula</h2>
<ul>
<li>it doesn’t make sense to consider effects that apply equally to all traits</li>
<li>so, let trait interact with all the other variables, but nothing else - use <code>-1</code> to drop intercept</li>
<li>specification is equivalent to
<ul>
<li><code>trait:(1+genotype+temp+genotype:temp)</code></li>
<li><strong>or</strong> <code>trait + trait:genotype + trait:temp + trait:genotype:temp</code></li>
</ul></li>
</ul>
<h2 id="lme4-random-effects-formula">lme4: random-effects formula</h2>
<ul>
<li><code>(trait-1|line)</code> means “variance/covariances of traits among lines”</li>
<li><code>-1</code> so we consider traits, not <em>differences</em> among traits</li>
<li><code>(trait-1|units)</code> specifies “var/cov of traits among units (individuals)”</li>
<li><code>lmer</code> always includes a residual variance term. This is redundant because we have only one data point per individual per trait: <code>lmerControl(...)</code> tells <code>lmer</code> not complain</li>
<li>As a result, our within-individual correlation estimates will be slightly overestimated (not so for GLMMs)</li>
</ul>
<h2 id="notes-on-lme4-results">Notes on lme4 results</h2>
<ul>
<li>the fit is a little slow (18 seconds on my laptop) (GLMMs would be even slower)</li>
<li><code>print(lmer1)</code>, <code>summary(lmer1)</code> useful but awkward (16 fixed effect coefficients, we’ll look at graphical summaries instead</li>
<li><code>fixef()</code> (fixed effects), <code>ranef()</code> (line/indiv deviations from pop mean), <code>coef()</code> (line/indiv-level estimates), <code>VarCorr</code> (random effects var/cov)</li>
</ul>
<h2 id="lme4-random-effects-varcov">lme4: random-effects var/cov</h2>
<ul>
<li>underlying var-cov parameters are labeled <span class="math inline">\(\theta\)</span>: <code>getME(fit,&quot;theta&quot;)</code> extracts them</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all</span>(<span class="kw">abs</span>(<span class="kw">getME</span>(lmer1,<span class="st">&quot;theta&quot;</span>))&gt;<span class="fl">1e-4</span>) ## check for singularity (OK in this case)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">VarCorr</span>(lmer1)</code></pre></div>
<pre><code>##  Groups   Name          Std.Dev. Corr          
##  units    traitfemur_s  0.648                  
##           traitSCT_s    0.723    0.06          
##           traittarsus_s 0.558    0.59 0.21     
##           traittibia_s  0.664    0.93 0.12 0.48
##  line     traitfemur_s  0.489                  
##           traitSCT_s    0.392    0.14          
##           traittarsus_s 0.462    0.81 0.37     
##           traittibia_s  0.473    0.87 0.22 0.83
##  Residual               0.471</code></pre>
<h2 id="lme4-correlation-plot">lme4: correlation plot</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
vv1 &lt;-<span class="st"> </span><span class="kw">VarCorr</span>(lmer1)
## fix unit variance-covariance by adding residual variance:
<span class="kw">diag</span>(vv1$units) &lt;-<span class="st"> </span><span class="kw">diag</span>(vv1$units)+<span class="kw">sigma</span>(lmer1)^<span class="dv">2</span>
<span class="kw">corrplot.mixed</span>(<span class="kw">cov2cor</span>(vv1$line),<span class="dt">upper=</span><span class="st">&quot;ellipse&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): could not find function &quot;corrplot.mixed&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">corrplot.mixed</span>(<span class="kw">cov2cor</span>(vv1$units),<span class="dt">upper=</span><span class="st">&quot;ellipse&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): could not find function &quot;corrplot.mixed&quot;</code></pre>
<p>Correlations of traits across lines are stronger than correlations within individuals. In both cases correlations are all positive (i.e. first axis of variation is <em>size</em> variation?)</p>
<h2 id="lme4-coefficient-plot">lme4: coefficient plot</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dwplot</span>(lmer1)+<span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<div class="figure">
<img src="figure/dwplot-1.png" alt="plot of chunk dwplot" />
<p class="caption">plot of chunk dwplot</p>
</div>
<p>These results tell approximately the same story (coefficients are consistent across traits within a fixed effect, e.g. effect of higher temperature is to reduce scores on all traits).</p>
<h1 id="mcmcglmm">MCMCglmm</h1>
<p>Another option is the <code>MCMCglmm</code> package, which has a natural interface for general multivariate mixed models. It takes a while to get used to the interface, but here is an example. Please check out <a href="https://cran.r-project.org/web/packages/MCMCglmm/index.html">here</a> for more information about the package, and <a href="https://cran.r-project.org/web/packages/MCMCglmm/vignettes/Overview.pdf">here</a> for an overview of how to use this package.</p>
<p>First I find it easier (given the interface of MCMCglmm) to create a formula with the response variables and predictors. This is only for the fixed effects part of the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fmla.MMLM1  &lt;-<span class="st"> </span><span class="kw">cbind</span>(femur_s, tibia_s, tarsus_s, SCT_s) ~
<span class="st">    </span>trait:(genotype*temp) -<span class="st"> </span><span class="dv">1</span></code></pre></div>
<p>Now we need to let <code>MCMCglmm</code> know which family (i.e. distribution) the response variables are. Since all are normal (Gaussian), we can specify it the following way.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fam.test &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&quot;gaussian&quot;</span>, <span class="dv">4</span> )</code></pre></div>
<p>Since <code>MCMCglmm</code> is fundamentally a Bayesian approach, it needs a prior. If you provide no prior by default, it tries a “flat” prior, although this rarely works. In this case I am providing a not-quite-flat prior, but just for the random effects of line and for the residual variances (could also provide them for the fixed effects).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prior.model<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">list</span>( <span class="dt">R=</span><span class="kw">list</span>(<span class="dt">V=</span><span class="kw">diag</span>(<span class="dv">4</span>)/<span class="dv">4</span>, <span class="dt">nu=</span><span class="fl">0.004</span>),  
                       <span class="dt">G=</span><span class="kw">list</span>(<span class="dt">G1=</span><span class="kw">list</span>(<span class="dt">V=</span><span class="kw">diag</span>(<span class="dv">4</span>)/<span class="dv">4</span>, <span class="dt">nu=</span><span class="fl">0.004</span>)))</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##,depends.on=c(&quot;prior&quot;,&quot;mod_fm&quot;,&quot;get_data&quot;)}
t2 &lt;-<span class="st"> </span><span class="kw">system.time</span>(
    MMLM1.fit &lt;-<span class="st"> </span><span class="kw">MCMCglmm</span>(fmla.MMLM1,
                          <span class="dt">random=</span>~<span class="st"> </span><span class="kw">us</span>(trait):line, 
                          <span class="dt">rcov=</span>~<span class="st"> </span><span class="kw">us</span>(trait):units,
                          <span class="dt">prior=</span>  prior.model<span class="fl">.1</span>,
                          <span class="dt">data=</span> dll_data2, 
                          <span class="dt">family =</span> fam.test, 
                          <span class="dt">nitt=</span> <span class="dv">10000</span>, <span class="dt">burnin=</span> <span class="dv">2000</span>, <span class="dt">thin=</span><span class="dv">10</span>)
)</code></pre></div>
<h2 id="mcmcglmm-specification-fixed-effects">MCMCglmm specification: fixed effects</h2>
<ul>
<li><code>fmla.MMLM1</code> is the formula object we created above</li>
<li>it looks like the <code>lmer</code> formula</li>
<li>the <code>trait</code> term is a reserved word in <code>MCMCglmm</code>, letting it know we want to fit a multivariate mixed model</li>
<li><code>MCMCglmm</code> automatically melts the data for us (and assigns the name <code>trait</code> the same way we did manually above)</li>
</ul>
<h2 id="mcmcglmm-random-effects">MCMCglmm: random effects</h2>
<ul>
<li><code>random=~us(trait):line</code> asks <code>MCMCglmm</code> to fit an <em>unstructured</em> covariance matrix for the line term (i.e the different wild type genotypes we are examining).- “Unstructured” means we are estimating the complete 4 x 4 matrix of covariances (= 4*5/2 = 10 elements total)</li>
<li>equivalent to <code>(trait-1|line)</code> in <code>lmer</code> model</li>
<li><code>MCMCglmm</code> also automatically adds a <code>units</code></li>
<li><code>rcov=~us(trait):units</code> = <code>(trait-1|units)</code></li>
<li><code>MCMCglmm</code> offers a few other options for variance-covariance structures</li>
</ul>
<h2 id="mcmcglmm-other-options">MCMCglmm: other options</h2>
<p>The <code>nitt</code> is how many iterations for the MCMC we want to perform, and the <code>burnin</code> is how many should be ignored at the beginning of the random walk.</p>
<h2 id="mcmcglmm-diagnostics">MCMCglmm: diagnostics</h2>
<p>The fit takes 23 seconds.</p>
<p>Normally we would spend a fair bit of time on diagnostics of the MCMC, but for now we will just quickly check the trace plots and autocorrelation.</p>
<p>In the fitted object <code>$Sol</code> is for solution, which is the term used for fixed effects in MCMCglmm. <code>$VCV</code> is for the variance-covariance matrix.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lattice)
<span class="kw">xyplot</span>(MMLM1.fit$Sol[,<span class="dv">1</span>:<span class="dv">4</span>])</code></pre></div>
<div class="figure">
<img src="figure/diag_plots-1.png" alt="plot of chunk diag_plots" />
<p class="caption">plot of chunk diag_plots</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xyplot</span>(MMLM1.fit$Sol[,<span class="dv">13</span>:<span class="dv">16</span>])</code></pre></div>
<div class="figure">
<img src="figure/diag_plots-2.png" alt="plot of chunk diag_plots" />
<p class="caption">plot of chunk diag_plots</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">acf</span>(MMLM1.fit$Sol[,<span class="dv">1</span>:<span class="dv">2</span>])</code></pre></div>
<div class="figure">
<img src="figure/diag_plots-3.png" alt="plot of chunk diag_plots" />
<p class="caption">plot of chunk diag_plots</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xyplot</span>(MMLM1.fit$VCV[,<span class="dv">1</span>:<span class="dv">4</span>])</code></pre></div>
<div class="figure">
<img src="figure/diag_plots-4.png" alt="plot of chunk diag_plots" />
<p class="caption">plot of chunk diag_plots</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">acf</span>(MMLM1.fit$VCV[,<span class="dv">1</span>:<span class="dv">3</span>])</code></pre></div>
<div class="figure">
<img src="figure/diag_plots-5.png" alt="plot of chunk diag_plots" />
<p class="caption">plot of chunk diag_plots</p>
</div>
<p>Nothing terribly worrying.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(MMLM1.fit)</code></pre></div>
<pre><code>## 
##  Iterations = 2001:9991
##  Thinning interval  = 10
##  Sample size  = 800 
## 
##  DIC: 17452 
## 
##  G-structure:  ~us(trait):line
## 
##                                  post.mean l-95% CI u-95% CI eff.samp
## traitfemur_s:traitfemur_s.line      0.2937   0.1443    0.496      800
## traittibia_s:traitfemur_s.line      0.2481   0.0956    0.413      800
## traittarsus_s:traitfemur_s.line     0.2244   0.1007    0.388      800
## traitSCT_s:traitfemur_s.line        0.0313  -0.0667    0.147      696
## traitfemur_s:traittibia_s.line      0.2481   0.0956    0.413      800
## traittibia_s:traittibia_s.line      0.2753   0.1382    0.458      800
## traittarsus_s:traittibia_s.line     0.2211   0.0841    0.363      800
## traitSCT_s:traittibia_s.line        0.0475  -0.0594    0.151      660
## traitfemur_s:traittarsus_s.line     0.2244   0.1007    0.388      800
## traittibia_s:traittarsus_s.line     0.2211   0.0841    0.363      800
## traittarsus_s:traittarsus_s.line    0.2591   0.1263    0.420      800
## traitSCT_s:traittarsus_s.line       0.0780  -0.0240    0.188      685
## traitfemur_s:traitSCT_s.line        0.0313  -0.0667    0.147      696
## traittibia_s:traitSCT_s.line        0.0475  -0.0594    0.151      660
## traittarsus_s:traitSCT_s.line       0.0780  -0.0240    0.188      685
## traitSCT_s:traitSCT_s.line          0.1861   0.0800    0.299      800
## 
##  R-structure:  ~us(trait):units
## 
##                                   post.mean l-95% CI u-95% CI eff.samp
## traitfemur_s:traitfemur_s.units      0.6447  0.60424   0.6858      800
## traittibia_s:traitfemur_s.units      0.4017  0.37006   0.4389      800
## traittarsus_s:traitfemur_s.units     0.2155  0.18688   0.2433      800
## traitSCT_s:traitfemur_s.units        0.0266 -0.00486   0.0600      800
## traitfemur_s:traittibia_s.units      0.4017  0.37006   0.4389      800
## traittibia_s:traittibia_s.units      0.6654  0.62184   0.7062      800
## traittarsus_s:traittibia_s.units     0.1798  0.14786   0.2055      800
## traitSCT_s:traittibia_s.units        0.0602  0.02758   0.0943      657
## traitfemur_s:traittarsus_s.units     0.2155  0.18688   0.2433      800
## traittibia_s:traittarsus_s.units     0.1798  0.14786   0.2055      800
## traittarsus_s:traittarsus_s.units    0.5345  0.50335   0.5729      800
## traitSCT_s:traittarsus_s.units       0.0840  0.05133   0.1128      800
## traitfemur_s:traitSCT_s.units        0.0266 -0.00486   0.0600      800
## traittibia_s:traitSCT_s.units        0.0602  0.02758   0.0943      657
## traittarsus_s:traitSCT_s.units       0.0840  0.05133   0.1128      800
## traitSCT_s:traitSCT_s.units          0.7475  0.69999   0.7936      602
## 
##  Location effects: cbind(femur_s, tibia_s, tarsus_s, SCT_s) ~ trait:(genotype * temp) - 1 
## 
##                                 post.mean l-95% CI u-95% CI eff.samp
## traitfemur_s:genotypeDll           0.5091   0.2905   0.7221      800
## traittibia_s:genotypeDll           0.6388   0.4401   0.8549      800
## traittarsus_s:genotypeDll          0.6158   0.4218   0.8183      709
## traitSCT_s:genotypeDll             0.6813   0.5033   0.8533      800
## traitfemur_s:genotypewt            0.1792  -0.0418   0.3657      800
## traittibia_s:genotypewt            0.0193  -0.2099   0.2089      800
## traittarsus_s:genotypewt           0.4445   0.2509   0.6371      717
## traitSCT_s:genotypewt             -0.0824  -0.2828   0.0704      594
## traitfemur_s:temp30               -0.8324  -0.9435  -0.7229      973
## traittibia_s:temp30               -0.8077  -0.9233  -0.6898      800
## traittarsus_s:temp30              -1.2391  -1.3404  -1.1346      800
## traitSCT_s:temp30                 -0.8384  -0.9409  -0.7138      775
## traitfemur_s:genotypewt:temp30     0.3589   0.2015   0.4865      930
## traittibia_s:genotypewt:temp30     0.4726   0.3311   0.6232      800
## traittarsus_s:genotypewt:temp30    0.5184   0.3757   0.6421      778
## traitSCT_s:genotypewt:temp30       0.7264   0.5770   0.8724      800
##                                  pMCMC   
## traitfemur_s:genotypeDll        &lt;0.001 **
## traittibia_s:genotypeDll        &lt;0.001 **
## traittarsus_s:genotypeDll       &lt;0.001 **
## traitSCT_s:genotypeDll          &lt;0.001 **
## traitfemur_s:genotypewt          0.077 . 
## traittibia_s:genotypewt          0.873   
## traittarsus_s:genotypewt        &lt;0.001 **
## traitSCT_s:genotypewt            0.328   
## traitfemur_s:temp30             &lt;0.001 **
## traittibia_s:temp30             &lt;0.001 **
## traittarsus_s:temp30            &lt;0.001 **
## traitSCT_s:temp30               &lt;0.001 **
## traitfemur_s:genotypewt:temp30  &lt;0.001 **
## traittibia_s:genotypewt:temp30  &lt;0.001 **
## traittarsus_s:genotypewt:temp30 &lt;0.001 **
## traitSCT_s:genotypewt:temp30    &lt;0.001 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Sometimes it is easier to look at the fixed and random effects separately.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(MMLM1.fit$Sol)</code></pre></div>
<pre><code>## 
## Iterations = 2001:9991
## Thinning interval = 10 
## Number of chains = 1 
## Sample size per chain = 800 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##                                    Mean     SD Naive SE Time-series SE
## traitfemur_s:genotypeDll         0.5091 0.1092  0.00386        0.00386
## traittibia_s:genotypeDll         0.6388 0.1058  0.00374        0.00374
## traittarsus_s:genotypeDll        0.6158 0.1041  0.00368        0.00391
## traitSCT_s:genotypeDll           0.6813 0.0938  0.00332        0.00332
## traitfemur_s:genotypewt          0.1792 0.1046  0.00370        0.00370
## traittibia_s:genotypewt          0.0193 0.1036  0.00366        0.00366
## traittarsus_s:genotypewt         0.4445 0.1002  0.00354        0.00374
## traitSCT_s:genotypewt           -0.0824 0.0894  0.00316        0.00367
## traitfemur_s:temp30             -0.8324 0.0572  0.00202        0.00183
## traittibia_s:temp30             -0.8077 0.0595  0.00211        0.00211
## traittarsus_s:temp30            -1.2391 0.0524  0.00185        0.00185
## traitSCT_s:temp30               -0.8384 0.0601  0.00212        0.00216
## traitfemur_s:genotypewt:temp30   0.3589 0.0741  0.00262        0.00243
## traittibia_s:genotypewt:temp30   0.4726 0.0759  0.00268        0.00268
## traittarsus_s:genotypewt:temp30  0.5184 0.0700  0.00247        0.00251
## traitSCT_s:genotypewt:temp30     0.7264 0.0767  0.00271        0.00271
## 
## 2. Quantiles for each variable:
## 
##                                    2.5%     25%     50%     75%   97.5%
## traitfemur_s:genotypeDll         0.3029  0.4380  0.5068  0.5757  0.7396
## traittibia_s:genotypeDll         0.4411  0.5659  0.6438  0.7072  0.8550
## traittarsus_s:genotypeDll        0.4125  0.5456  0.6188  0.6857  0.8106
## traitSCT_s:genotypeDll           0.5074  0.6182  0.6814  0.7448  0.8625
## traitfemur_s:genotypewt         -0.0199  0.1096  0.1799  0.2423  0.3953
## traittibia_s:genotypewt         -0.1840 -0.0525  0.0150  0.0811  0.2414
## traittarsus_s:genotypewt         0.2478  0.3803  0.4471  0.5080  0.6331
## traitSCT_s:genotypewt           -0.2713 -0.1410 -0.0786 -0.0226  0.0923
## traitfemur_s:temp30             -0.9453 -0.8711 -0.8328 -0.7961 -0.7231
## traittibia_s:temp30             -0.9225 -0.8486 -0.8104 -0.7666 -0.6897
## traittarsus_s:temp30            -1.3454 -1.2738 -1.2405 -1.2036 -1.1380
## traitSCT_s:temp30               -0.9573 -0.8789 -0.8398 -0.7992 -0.7236
## traitfemur_s:genotypewt:temp30   0.2083  0.3107  0.3619  0.4074  0.5002
## traittibia_s:genotypewt:temp30   0.3157  0.4211  0.4740  0.5238  0.6148
## traittarsus_s:genotypewt:temp30  0.3800  0.4721  0.5203  0.5658  0.6480
## traitSCT_s:genotypewt:temp30     0.5769  0.6743  0.7286  0.7788  0.8717</code></pre>
<p>And for the random effects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(MMLM1.fit$VCV)</code></pre></div>
<pre><code>## 
## Iterations = 2001:9991
## Thinning interval = 10 
## Number of chains = 1 
## Sample size per chain = 800 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##                                     Mean     SD Naive SE Time-series SE
## traitfemur_s:traitfemur_s.line    0.2937 0.0945 0.003342       0.003342
## traittibia_s:traitfemur_s.line    0.2481 0.0860 0.003041       0.003041
## traittarsus_s:traitfemur_s.line   0.2244 0.0802 0.002835       0.002835
## traitSCT_s:traitfemur_s.line      0.0313 0.0539 0.001905       0.002042
## traitfemur_s:traittibia_s.line    0.2481 0.0860 0.003041       0.003041
## traittibia_s:traittibia_s.line    0.2753 0.0900 0.003183       0.003183
## traittarsus_s:traittibia_s.line   0.2211 0.0788 0.002785       0.002785
## traitSCT_s:traittibia_s.line      0.0475 0.0533 0.001885       0.002076
## traitfemur_s:traittarsus_s.line   0.2244 0.0802 0.002835       0.002835
## traittibia_s:traittarsus_s.line   0.2211 0.0788 0.002785       0.002785
## traittarsus_s:traittarsus_s.line  0.2591 0.0831 0.002936       0.002936
## traitSCT_s:traittarsus_s.line     0.0780 0.0529 0.001870       0.002022
## traitfemur_s:traitSCT_s.line      0.0313 0.0539 0.001905       0.002042
## traittibia_s:traitSCT_s.line      0.0475 0.0533 0.001885       0.002076
## traittarsus_s:traitSCT_s.line     0.0780 0.0529 0.001870       0.002022
## traitSCT_s:traitSCT_s.line        0.1861 0.0620 0.002191       0.002191
## traitfemur_s:traitfemur_s.units   0.6447 0.0208 0.000734       0.000734
## traittibia_s:traitfemur_s.units   0.4017 0.0178 0.000631       0.000631
## traittarsus_s:traitfemur_s.units  0.2155 0.0149 0.000527       0.000527
## traitSCT_s:traitfemur_s.units     0.0266 0.0163 0.000577       0.000577
## traitfemur_s:traittibia_s.units   0.4017 0.0178 0.000631       0.000631
## traittibia_s:traittibia_s.units   0.6654 0.0218 0.000771       0.000771
## traittarsus_s:traittibia_s.units  0.1798 0.0150 0.000530       0.000530
## traitSCT_s:traittibia_s.units     0.0602 0.0172 0.000608       0.000671
## traitfemur_s:traittarsus_s.units  0.2155 0.0149 0.000527       0.000527
## traittibia_s:traittarsus_s.units  0.1798 0.0150 0.000530       0.000530
## traittarsus_s:traittarsus_s.units 0.5345 0.0181 0.000639       0.000639
## traitSCT_s:traittarsus_s.units    0.0840 0.0155 0.000548       0.000548
## traitfemur_s:traitSCT_s.units     0.0266 0.0163 0.000577       0.000577
## traittibia_s:traitSCT_s.units     0.0602 0.0172 0.000608       0.000671
## traittarsus_s:traitSCT_s.units    0.0840 0.0155 0.000548       0.000548
## traitSCT_s:traitSCT_s.units       0.7475 0.0248 0.000878       0.001013
## 
## 2. Quantiles for each variable:
## 
##                                       2.5%      25%    50%    75%  97.5%
## traitfemur_s:traitfemur_s.line     0.15864  0.22696 0.2744 0.3438 0.5292
## traittibia_s:traitfemur_s.line     0.12270  0.18689 0.2358 0.2963 0.4610
## traittarsus_s:traitfemur_s.line    0.11095  0.16759 0.2075 0.2661 0.4283
## traitSCT_s:traitfemur_s.line      -0.07103 -0.00149 0.0290 0.0629 0.1455
## traitfemur_s:traittibia_s.line     0.12270  0.18689 0.2358 0.2963 0.4610
## traittibia_s:traittibia_s.line     0.14855  0.21290 0.2613 0.3209 0.4900
## traittarsus_s:traittibia_s.line    0.10951  0.16444 0.2058 0.2656 0.4197
## traitSCT_s:traittibia_s.line      -0.05277  0.01268 0.0447 0.0783 0.1581
## traitfemur_s:traittarsus_s.line    0.11095  0.16759 0.2075 0.2661 0.4283
## traittibia_s:traittarsus_s.line    0.10951  0.16444 0.2058 0.2656 0.4197
## traittarsus_s:traittarsus_s.line   0.14118  0.20015 0.2461 0.3009 0.4685
## traitSCT_s:traittarsus_s.line     -0.01533  0.04271 0.0729 0.1065 0.2004
## traitfemur_s:traitSCT_s.line      -0.07103 -0.00149 0.0290 0.0629 0.1455
## traittibia_s:traitSCT_s.line      -0.05277  0.01268 0.0447 0.0783 0.1581
## traittarsus_s:traitSCT_s.line     -0.01533  0.04271 0.0729 0.1065 0.2004
## traitSCT_s:traitSCT_s.line         0.10109  0.14535 0.1738 0.2178 0.3356
## traitfemur_s:traitfemur_s.units    0.60422  0.63144 0.6445 0.6591 0.6858
## traittibia_s:traitfemur_s.units    0.36824  0.38902 0.4027 0.4134 0.4377
## traittarsus_s:traitfemur_s.units   0.18631  0.20557 0.2151 0.2249 0.2432
## traitSCT_s:traitfemur_s.units     -0.00637  0.01506 0.0278 0.0372 0.0590
## traitfemur_s:traittibia_s.units    0.36824  0.38902 0.4027 0.4134 0.4377
## traittibia_s:traittibia_s.units    0.62244  0.65011 0.6645 0.6796 0.7095
## traittarsus_s:traittibia_s.units   0.15133  0.16965 0.1797 0.1903 0.2094
## traitSCT_s:traittibia_s.units      0.02464  0.04865 0.0599 0.0719 0.0928
## traitfemur_s:traittarsus_s.units   0.18631  0.20557 0.2151 0.2249 0.2432
## traittibia_s:traittarsus_s.units   0.15133  0.16965 0.1797 0.1903 0.2094
## traittarsus_s:traittarsus_s.units  0.50102  0.52221 0.5343 0.5460 0.5711
## traitSCT_s:traittarsus_s.units     0.05247  0.07396 0.0845 0.0942 0.1147
## traitfemur_s:traitSCT_s.units     -0.00637  0.01506 0.0278 0.0372 0.0590
## traittibia_s:traitSCT_s.units      0.02464  0.04865 0.0599 0.0719 0.0928
## traittarsus_s:traitSCT_s.units     0.05247  0.07396 0.0845 0.0942 0.1147
## traitSCT_s:traitSCT_s.units        0.70075  0.73041 0.7477 0.7649 0.7957</code></pre>
<p>This is not the most friendly output, and it takes a while to get used to. However, we can see that we still have evidence for something interesting going, and we could extract the vectors of effects as we did above.</p>
<p>let’s look at the VCV matrix for the random effects of line in a slightly clearer way (as a matrix)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##&#39; extract variance-covariance matrices for MCMCglmm objects
##&#39; does not (yet) set cor, stddev, residual-var attributes
##&#39; may be fragile: depends on group vars not having dots in them?
VarCorr.MCMCglmm &lt;-<span class="st"> </span>function(object, ...) {
    s &lt;-<span class="st"> </span><span class="kw">summary</span>(object$VCV)$statistics[,<span class="st">&quot;Mean&quot;</span>]
    grps &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;^[^.]+</span><span class="ch">\\</span><span class="st">.([[:alnum:]]+)$&quot;</span>,<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>,<span class="kw">names</span>(s))
    ss &lt;-<span class="st"> </span><span class="kw">split</span>(s,grps)
    getVC &lt;-<span class="st"> </span>function(x) {
        nms &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;^([^.]+)</span><span class="ch">\\</span><span class="st">.[[:alnum:]]+$&quot;</span>,<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>,<span class="kw">names</span>(x))
        n &lt;-<span class="st"> </span><span class="kw">length</span>(nms)
        L &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">sqrt</span>(n))
        dimnms &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;^([^:]+):.*$&quot;</span>,<span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>,nms[<span class="dv">1</span>:L])
        <span class="kw">return</span>(<span class="kw">matrix</span>(x,<span class="dt">dimnames=</span><span class="kw">list</span>(dimnms,dimnms),
                      <span class="dt">nrow=</span>L))
    }
    r &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">lapply</span>(ss,getVC),<span class="kw">unique</span>(grps))
    <span class="kw">return</span>(r)
}
vv &lt;-<span class="st"> </span><span class="kw">VarCorr</span>(MMLM1.fit)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))
<span class="kw">corrplot.mixed</span>(<span class="kw">cov2cor</span>(vv$line),<span class="dt">upper=</span><span class="st">&quot;ellipse&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): could not find function &quot;corrplot.mixed&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">corrplot.mixed</span>(<span class="kw">cov2cor</span>(vv$units),<span class="dt">upper=</span><span class="st">&quot;ellipse&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): could not find function &quot;corrplot.mixed&quot;</code></pre>
<ul>
<li>among-line effects are very similar to <code>lme4</code> estimates (variables are in a different order)</li>
<li>among-individual effects a</li>
</ul>
<p>This is only a taste of what to do, and after this we could start asking questions about this genetic variance co-variance matrix.</p>
<p>Compare fixed effects:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tt &lt;-<span class="st"> </span><span class="kw">tidy</span>(MMLM1.fit)</code></pre></div>
<pre><code>## Warning in tidy.default(MMLM1.fit): No method for tidying an S3 object of
## class MCMCglmm , using as.data.frame</code></pre>
<pre><code>## Error in as.data.frame.default(x): cannot coerce class &quot;&quot;MCMCglmm&quot;&quot; to a data.frame</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tt2 &lt;-<span class="st"> </span><span class="kw">tidy</span>(lmer1)
tt_comb &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(<span class="dt">lmer=</span>tt,<span class="dt">MCMCglmm=</span>tt2,<span class="dt">.id=</span><span class="st">&quot;model&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">filter</span>(effect==<span class="st">&quot;fixed&quot;</span>)</code></pre></div>
<pre><code>## Error in list_or_dots(...): object &#39;tt&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dwplot</span>(tt_comb)+<span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>,<span class="dt">lty=</span><span class="dv">2</span>)</code></pre></div>
<pre><code>## Error in is.data.frame(x): object &#39;tt_comb&#39; not found</code></pre>
<h2 id="pros-and-cons">Pros and cons</h2>
<ul>
<li>MCMCglmm: Bayesian
<ul>
<li>easier to get various kinds of confidence intervals</li>
<li>flexible priors</li>
<li>more flexible variance structures</li>
<li>multiple response types within a unit (e.g. Gaussian + Poisson)</li>
</ul></li>
<li>lme4: frequentist
<ul>
<li>faster</li>
<li>simpler interface (??)</li>
<li>more convenient outputs</li>
</ul></li>
<li>other options: <code>glmmTMB</code>, <code>brms</code> …</li>
</ul>
<div id="footer">
	<div style="text-align:center">
		<a href="index.html">Course home page</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="mailto:bio708qmee@gmail.com">Email the profs</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="logo.html">Logo information</a>
	</div>
</div>
</body>
</html>
