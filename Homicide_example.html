<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Ben Bolker" />
  <title>Canadian homicide rates</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="qmee.css" type="text/css" />
</head>
<body>
<header class="site-header">
<div class="wrapper">
	<h1 class="title">
		<a href="index.html">Biology 708, McMaster University</a>
	</h1>
	<div style="text-align:center">
		<img src="http://imgs.xkcd.com/comics/self_description.png">
	</div>
</div>
</header>
<div id="header">
<h1 class="title">Canadian homicide rates</h1>
<h2 class="author">Ben Bolker</h2>
</div>
<h2 id="read-data-in-wide-format-and-play-with-it">Read data in wide format and play with it</h2>
<p>Data are originally from <a href="http://www.statcan.gc.ca/tables-tableaux/sum-som/l01/cst01/legal12b-eng.htm">StatCan</a> (it might be possible to <em>scrape</em> this data set using the <code>XML</code> package …).</p>
<p>I also got <a href="http://en.wikipedia.org/wiki/List_of_Canadian_provinces_and_territories_by_population">data on population size in 2011 from Wikipedia</a> .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;CA_homicide.csv&quot;</span>,<span class="dt">check.names=</span><span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Warning in file(file, &quot;rt&quot;): cannot open file &#39;CA_homicide.csv&#39;: No such
## file or directory</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">popdat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;popdat.csv&quot;</span>)</code></pre></div>
<pre><code>## Warning in file(file, &quot;rt&quot;): cannot open file &#39;popdat.csv&#39;: No such file or
## directory</code></pre>
<pre><code>## Error in file(file, &quot;rt&quot;): cannot open the connection</code></pre>
<p>We use <code>check.names=FALSE</code> to stop R from trying to sanitize the column names: this is reasonable if we plan to convert to long form and want to preserve the values (years, in this case).</p>
<p>These data are in wide format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(dat)</code></pre></div>
<pre><code>## Error in head(dat): object &#39;dat&#39; not found</code></pre>
<p>What if we want combine other information?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(rdat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Place=</span>dat$Place,
      <span class="dt">Region=</span><span class="kw">c</span>(<span class="st">&quot;all&quot;</span>,<span class="kw">rep</span>(<span class="st">&quot;Atlantic&quot;</span>,<span class="dv">4</span>),
             <span class="kw">rep</span>(<span class="st">&quot;East&quot;</span>,<span class="dv">2</span>),
             <span class="kw">rep</span>(<span class="st">&quot;West&quot;</span>,<span class="dv">4</span>),
             <span class="kw">rep</span>(<span class="st">&quot;North&quot;</span>,<span class="dv">3</span>))))</code></pre></div>
<pre><code>## Error in data.frame(Place = dat$Place, Region = c(&quot;all&quot;, rep(&quot;Atlantic&quot;, : object &#39;dat&#39; not found</code></pre>
<p>Let’s start by converting the data to long form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)</code></pre></div>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat &lt;-<span class="st"> </span>dat %&gt;%<span class="st"> </span><span class="kw">gather</span>(year,homicides,-Place,<span class="dt">convert=</span><span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;dat&#39; not found</code></pre>
<p>(we use <code>convert=TRUE</code> to convert the years back to numeric values)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 &lt;-<span class="st"> </span>sdat %&gt;%<span class="st"> </span><span class="kw">full_join</span>(rdat) %&gt;%<span class="st"> </span><span class="kw">full_join</span>(popdat)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat&#39; not found</code></pre>
<p>If we just used the original data set (without the added stuff), it’s fairly easy to get summary statistics by dropping the first row (so that we have a data frame that is all numeric) and computing means of rows and columns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dmat &lt;-<span class="st"> </span>dat[,-<span class="dv">1</span>]</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;dat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rownames</span>(dmat) &lt;-<span class="st"> </span>dat[,<span class="dv">1</span>]</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;dat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rowMeans</span>(dmat)  ## means by place</code></pre></div>
<pre><code>## Error in is.data.frame(x): object &#39;dmat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colMeans</span>(dmat)  ## means by year</code></pre></div>
<pre><code>## Error in is.data.frame(x): object &#39;dmat&#39; not found</code></pre>
<p>(Don’t forget the <code>na.rm</code> argument, unnecessary in this case, that can be provided to most R summary functions to get them to ignore <code>NA</code> values.)</p>
<p>If we want summary statistics from the full data set we can do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(Place) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(year) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<p>One more useful technique is reordering factors (representing categorical variables) in a sensible way. Right now the ‘places’ (provinces, territories, etc.) are ordered alphabetically, R’s default.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat3 &lt;-<span class="st"> </span>sdat2 %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Place=</span><span class="kw">reorder</span>(Place,Pop_2011))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<p>I can also group by two different variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(year,Region) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<p>What if I want the mean and standard error? R doesn’t have a built-in “standard error of the mean” function so I define one on the fly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sem &lt;-<span class="st"> </span>function(x) { <span class="kw">sd</span>(x)/<span class="kw">sqrt</span>(<span class="kw">length</span>(x))}
sdat2 %&gt;%<span class="st"> </span><span class="kw">group_by</span>(year,Region) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides,<span class="dt">na.rm=</span><span class="ot">TRUE</span>),
              <span class="dt">sem=</span><span class="kw">sem</span>(homicides))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<p>What if I want to check the variables to see why they’re <code>NA</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 %&gt;%<span class="st"> </span><span class="kw">filter</span>(year==<span class="dv">2007</span> &amp;<span class="st"> </span>Region==<span class="st">&quot;all&quot;</span>)</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;sdat2&#39; not found</code></pre>
<h2 id="hadleyverse-1">Hadleyverse 1</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">detach</span>(<span class="st">&quot;package:dplyr&quot;</span>)
<span class="kw">detach</span>(<span class="st">&quot;package:tidyr&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;plyr&quot;</span>)</code></pre></div>
<pre><code>## -------------------------------------------------------------------------</code></pre>
<pre><code>## You have loaded plyr after dplyr - this is likely to cause problems.
## If you need functions from both plyr and dplyr, please load plyr first, then dplyr:
## library(plyr); library(dplyr)</code></pre>
<pre><code>## -------------------------------------------------------------------------</code></pre>
<p>We can use <code>merge</code> to combine the data (without getting tricky, we can’t <code>merge</code> more than two data sets at a time)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat2 &lt;-<span class="st"> </span><span class="kw">merge</span>(dat,rdat)</code></pre></div>
<pre><code>## Error in merge(dat, rdat): object &#39;dat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat3 &lt;-<span class="st"> </span><span class="kw">merge</span>(dat2,popdat)</code></pre></div>
<pre><code>## Error in merge(dat2, popdat): object &#39;dat2&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(dat3)</code></pre></div>
<pre><code>## Error in head(dat3): object &#39;dat3&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Long format</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;reshape2&quot;</span>)</code></pre></div>
<p>Reshape data from wide to long (“melt”): since I added the population data, I can’t rely on <code>melt</code>’s default rule (ID variables=factor variables) but have to specify <code>id.var</code> explicitly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mdat &lt;-<span class="st"> </span><span class="kw">melt</span>(dat3,<span class="dt">variable.name=</span><span class="st">&quot;Year&quot;</span>,<span class="dt">id.var=</span><span class="kw">c</span>(<span class="st">&quot;Place&quot;</span>,<span class="st">&quot;Region&quot;</span>,<span class="st">&quot;Pop_2011&quot;</span>))</code></pre></div>
<pre><code>## Error in melt(dat3, variable.name = &quot;Year&quot;, id.var = c(&quot;Place&quot;, &quot;Region&quot;, : object &#39;dat3&#39; not found</code></pre>
<p>Now clean up, relabeling the value column and translating years back to a numeric variable:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mdat &lt;-<span class="st"> </span><span class="kw">rename</span>(mdat,<span class="kw">c</span>(<span class="dt">value=</span><span class="st">&quot;Hom_rate&quot;</span>))</code></pre></div>
<pre><code>## Error in revalue(names(x), replace, warn_missing = warn_missing): object &#39;mdat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mdat$Year &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(mdat$Year))</code></pre></div>
<pre><code>## Error in eval(expr, envir, enclos): object &#39;mdat&#39; not found</code></pre>
<p>We could also have <code>melt</code>ed the original data set (without region or population data) and waited until we had the data in long format to merge the extra information: <code>merge</code> is pretty smart.</p>
<h2 id="casting">Casting</h2>
<p>How do we summarize the data if we have it in long format?</p>
<p>Mean by place (I have to be a little careful with the way I <code>rename</code>: since <code>(all)</code> is not a legal R name, I have to surround it with back-quotes):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">place_mean &lt;-<span class="st"> </span><span class="kw">dcast</span>(mdat,Place~.,
      <span class="dt">value=</span><span class="st">&quot;Hom_rate&quot;</span>,<span class="dt">fun.aggregate=</span>mean)</code></pre></div>
<pre><code>## Error in match(x, table, nomatch = 0L): object &#39;mdat&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">place_mean &lt;-<span class="st"> </span><span class="kw">rename</span>(place_mean,<span class="kw">c</span>(<span class="st">`</span><span class="dt">(all)</span><span class="st">`</span>=<span class="st">&quot;mean_hom&quot;</span>))</code></pre></div>
<pre><code>## Error in revalue(names(x), replace, warn_missing = warn_missing): object &#39;place_mean&#39; not found</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(place_mean)</code></pre></div>
<pre><code>## Error in print(place_mean): object &#39;place_mean&#39; not found</code></pre>
<p>By year:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dcast</span>(mdat,Year~.,
      <span class="dt">value=</span><span class="st">&quot;Hom_rate&quot;</span>,<span class="dt">fun.aggregate=</span>mean)</code></pre></div>
<pre><code>## Error in match(x, table, nomatch = 0L): object &#39;mdat&#39; not found</code></pre>
<p>By region:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dcast</span>(mdat,Region~.,
      <span class="dt">value=</span><span class="st">&quot;Hom_rate&quot;</span>,<span class="dt">fun.aggregate=</span>mean)</code></pre></div>
<pre><code>## Error in match(x, table, nomatch = 0L): object &#39;mdat&#39; not found</code></pre>
<p>By region <em>and</em> year:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dcast</span>(mdat,Region+Year~.,
      <span class="dt">value=</span><span class="st">&quot;Hom_rate&quot;</span>,<span class="dt">fun.aggregate=</span>mean)</code></pre></div>
<pre><code>## Error in match(x, table, nomatch = 0L): object &#39;mdat&#39; not found</code></pre>
<p>To get multiple summaries in the same data frame, I need <code>plyr::ddply</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ddply</span>(mdat,<span class="st">&quot;Region&quot;</span>,summarise,
      <span class="dt">mean=</span><span class="kw">mean</span>(Hom_rate),<span class="dt">sem=</span><span class="kw">sem</span>(Hom_rate))</code></pre></div>
<pre><code>## Error in empty(.data): object &#39;mdat&#39; not found</code></pre>
<p>We could also cast it back into the original wide format, or into the transposed form, using <code>dcast(mdat,Year~Place)</code> or <code>dcast(mdat,Place~Year)</code>. <code>reshape2</code> can do considerably more complicated things, too.</p>
<p>In the long run it is generally easier to keep your data in long format and cast it to wide as necessary.</p>
<p>Save the data frame we’ve created:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">save</span>(<span class="st">&quot;mdat&quot;</span>,<span class="dt">file=</span><span class="st">&quot;CA_homicide.RData&quot;</span>)</code></pre></div>
<pre><code>## Error in save(&quot;mdat&quot;, file = &quot;CA_homicide.RData&quot;): object &#39;mdat&#39; not found</code></pre>
<div id="footer">
	<div style="text-align:center">
		<a href="index.html">Course home page</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="mailto:bio708qmee@gmail.com">Email the profs</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="logo.html">Logo information</a>
	</div>
</div>
</body>
</html>
