<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Ben Bolker" />
  <title>Canadian homicide rates</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="qmee.css" type="text/css" />
</head>
<body>
<header class="site-header">
<div class="wrapper">
	<h1 class="title">
		<a href="index.html">Biology 708, McMaster University</a>
	</h1>
	<div style="text-align:center">
		<img src="http://imgs.xkcd.com/comics/self_description.png">
	</div>
</div>
</header>
<div id="header">
<h1 class="title">Canadian homicide rates</h1>
<h2 class="author">Ben Bolker</h2>
<h3 class="date">15:26 16 January 2019</h3>
</div>
<h2 id="read-data-in-wide-format-and-play-with-it">Read data in wide format and play with it</h2>
<p>Data are originally from <a href="http://www.statcan.gc.ca/tables-tableaux/sum-som/l01/cst01/legal12b-eng.htm">here</a> (it might be possible to <em>scrape</em> this data set using the <code>XML</code> package …).</p>
<p>I also got <a href="http://en.wikipedia.org/wiki/List_of_Canadian_provinces_and_territories_by_population">data on population size in 2011 from Wikipedia</a> .</p>
<p>Read data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
dat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/CA_homicide.csv&quot;</span>, <span class="dt">col_types=</span><span class="kw">cols</span>())
popdat &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/CA_popdat.csv&quot;</span>, <span class="dt">col_types=</span><span class="kw">cols</span>())</code></pre></div>
<p>These data are in wide format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(dat)</code></pre></div>
<pre><code>## # A tibble: 6 x 6
##   Place                     `2007` `2008` `2009` `2010` `2011`
##   &lt;chr&gt;                      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 Canada                      1.8    1.83   1.81   1.62   1.73
## 2 Newfoundland and Labrador   0.59   0.99   0.2    0.78   0.78
## 3 Prince Edward Island        0      1.43   0      0      0.69
## 4 Nova Scotia                 1.39   1.28   1.6    2.22   2.33
## 5 New Brunswick               1.07   0.4    1.6    1.2    1.06
## 6 Quebec                      1.17   1.19   1.12   1.06   1.32</code></pre>
<p>What if we want combine other information?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(rdat &lt;-<span class="st"> </span><span class="kw">data_frame</span>(<span class="dt">Place=</span>dat<span class="op">$</span>Place,
      <span class="dt">Region=</span><span class="kw">c</span>(<span class="st">&quot;all&quot;</span>,<span class="kw">rep</span>(<span class="st">&quot;Atlantic&quot;</span>,<span class="dv">4</span>),
             <span class="kw">rep</span>(<span class="st">&quot;East&quot;</span>,<span class="dv">2</span>),
             <span class="kw">rep</span>(<span class="st">&quot;West&quot;</span>,<span class="dv">4</span>),
             <span class="kw">rep</span>(<span class="st">&quot;North&quot;</span>,<span class="dv">3</span>))))</code></pre></div>
<pre><code>## # A tibble: 6 x 2
##   Place                     Region  
##   &lt;chr&gt;                     &lt;chr&gt;   
## 1 Canada                    all     
## 2 Newfoundland and Labrador Atlantic
## 3 Prince Edward Island      Atlantic
## 4 Nova Scotia               Atlantic
## 5 New Brunswick             Atlantic
## 6 Quebec                    East</code></pre>
<p>Let’s start by converting the data to long form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat &lt;-<span class="st"> </span>(dat
    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(year,homicides,<span class="op">-</span>Place,<span class="dt">convert=</span><span class="ot">TRUE</span>)
)</code></pre></div>
<p>(we use <code>convert=TRUE</code> to convert the years back to numeric values)</p>
<p>Now combine all three data sets (<code>full_join</code> will automatically match all columns with identical names across the data sets, but it’s better practice to specify the matching columns explicitly).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 &lt;-<span class="st"> </span>sdat <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">full_join</span>(rdat,<span class="dt">by=</span><span class="st">&quot;Place&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">full_join</span>(popdat,<span class="dt">by=</span><span class="st">&quot;Place&quot;</span>)</code></pre></div>
<p>If we just used the original data set (without the added stuff), it’s fairly easy to get summary statistics by dropping the first row (so that we have a data frame that is all numeric) and computing means of rows and columns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dmat &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(dat[,<span class="op">-</span><span class="dv">1</span>])
<span class="kw">rownames</span>(dmat) &lt;-<span class="st"> </span>dat<span class="op">$</span>Place
<span class="kw">rowMeans</span>(dmat)  ## means by place</code></pre></div>
<pre><code>##                    Canada Newfoundland and Labrador 
##                     1.758                     0.668 
##      Prince Edward Island               Nova Scotia 
##                     0.424                     1.764 
##             New Brunswick                    Quebec 
##                     1.066                     1.172 
##                   Ontario                  Manitoba 
##                     1.386                     4.432 
##              Saskatchewan                   Alberta 
##                     3.262                     2.622 
##          British Columbia                     Yukon 
##                     2.218                     4.806 
##     Northwest Territories                   Nunavut 
##                     5.038                    18.584</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colMeans</span>(dmat)  ## means by year</code></pre></div>
<pre><code>##     2007     2008     2009     2010     2011 
## 3.812143 3.587857 3.588571 3.040000 3.542857</code></pre>
<p>(Don’t forget the <code>na.rm</code> argument, unnecessary in this case, that can be provided to most R summary functions to get them to ignore <code>NA</code> values.)</p>
<p>If we want summary statistics from the full data set we can do</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat2 <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(Place) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))
sdat2 <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))</code></pre></div>
<p>One more useful technique is reordering factors (representing categorical variables) in a sensible way. Right now the ‘places’ (provinces, territories, etc.) are ordered alphabetically, R’s default.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat3 &lt;-<span class="st"> </span>sdat2 <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Place=</span><span class="kw">reorder</span>(<span class="kw">factor</span>(Place),Pop_<span class="dv">2011</span>))</code></pre></div>
<p>This will be useful in the future, but is different from the <strong>order the data frame is stored in</strong>, which we can modify via <code>arrange()</code> (use <code>desc(Pop_2011)</code> to arrange in descending order of population):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(sdat3
    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Pop_<span class="dv">2011</span>))
    <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()
)</code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   Place    year homicides Region Pop_2011
##   &lt;fct&gt;   &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
## 1 Canada   2007      1.8  all    33476688
## 2 Canada   2008      1.83 all    33476688
## 3 Canada   2009      1.81 all    33476688
## 4 Canada   2010      1.62 all    33476688
## 5 Canada   2011      1.73 all    33476688
## 6 Ontario  2007      1.58 East   12851821</code></pre>
<p>I can also summarise by combinations of variables:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat3 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year,Region) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides))</code></pre></div>
<pre><code>## # A tibble: 25 x 3
## # Groups:   year [?]
##     year Region     mean
##    &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1  2007 all       1.8  
##  2  2007 Atlantic  0.762
##  3  2007 East      1.38 
##  4  2007 North    11.0  
##  5  2007 West      3.16 
##  6  2008 all       1.83 
##  7  2008 Atlantic  1.02 
##  8  2008 East      1.27 
##  9  2008 North     9.53 
## 10  2008 West      3.29 
## # ... with 15 more rows</code></pre>
<p>What if I want the mean and standard error? R doesn’t have a built-in “standard error of the mean” function so I define one on the fly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sem &lt;-<span class="st"> </span><span class="cf">function</span>(x) { <span class="kw">sd</span>(x)<span class="op">/</span><span class="kw">sqrt</span>(<span class="kw">length</span>(x)) }
region_avgs &lt;-<span class="st"> </span>sdat3 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(year,Region) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean=</span><span class="kw">mean</span>(homicides,<span class="dt">na.rm=</span><span class="ot">TRUE</span>),
              <span class="dt">sem=</span><span class="kw">sem</span>(homicides))</code></pre></div>
<p>What if I want to check the variables to see why they’re <code>NA</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sdat3 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year<span class="op">==</span><span class="dv">2007</span> <span class="op">&amp;</span><span class="st"> </span>Region<span class="op">==</span><span class="st">&quot;all&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   Place   year homicides Region Pop_2011
##   &lt;fct&gt;  &lt;int&gt;     &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
## 1 Canada  2007       1.8 all    33476688</code></pre>
<p>Sometimes it’s useful to be able to go from long to wide format. <code>spread()</code> is the opposite of <code>gather()</code>: we specify a column in the current data set to spread out into new columns (<code>key</code>) and a column to use as the vales for the table (<code>value</code>)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">region_avgs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>sem) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">spread</span>(<span class="dt">key=</span>Region,<span class="dt">value=</span>mean)</code></pre></div>
<pre><code>## # A tibble: 5 x 6
## # Groups:   year [5]
##    year   all Atlantic  East North  West
##   &lt;int&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  2007  1.8     0.762  1.38 11.0   3.16
## 2  2008  1.83    1.02   1.27  9.53  3.29
## 3  2009  1.81    0.85   1.24  9.71  3.36
## 4  2010  1.62    1.05   1.25  7.81  2.70
## 5  2011  1.73    1.22   1.26  9.29  3.15</code></pre>
<p>For analysis in R, it is generally best to keep your data in long format and <code>spread()</code> it to wide as necessary.</p>
<div id="footer">
	<div style="text-align:center">
		<a href="index.html">Course home page</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="mailto:bio708qmee@gmail.com">Email the profs</a>
		&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		<a href="logo.html">Logo information</a>
	</div>
</div>
</body>
</html>
